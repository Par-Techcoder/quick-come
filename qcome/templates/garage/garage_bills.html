{% extends "garage/index.html" %}
{% load static %}
{% block title %}Bills List{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/garage_bills.css' %}"> 

<div class="wrapper">
    <div class="container">
        <h2 class="billing-title">Billing Details</h2>
        <div id="bills-list">
            {% for bill in bills_data %}
            <div class="bill-card" id="bill-{{ bill.booking_id }}" onclick="openBill({{ bill.booking_id }})">
                <div class="bill-info">
                    <div class="bill-row">
                        <span class="customer"><strong>Booking ID:</strong> {{ bill.booking_id }}</span>
                        <span class="vehicle"><strong>Car Type:</strong> {{ bill.vehicle_type }}</span>
                        <span><strong>Payment Status:</strong> {{ bill.status }}</span>
                    </div>
                    <div class="bill-date">
                        <span><strong>Date:</strong> {{ bill.created_at|date:"d M Y, h:i A" }}</span>
                        <span class="total"><strong>Total:</strong> ‚Çπ{{ bill.total }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>    
</div>

<script>
function connectWebSocket() {
    const socket = new WebSocket("ws://localhost:8000/ws/garage_bills/");

    socket.onopen = function () {
        console.log("‚úÖ WebSocket connected successfully.");
    };

    socket.onmessage = function (event) {
        try {
            console.log("üîπ Raw WebSocket Data:", event.data);

            const data = JSON.parse(event.data);

            if (data.type === "bill_update") {
                console.log("üìå New Bill Update Received:", data);

                // Ensure bill data is correctly parsed
                const billData = typeof data.data === "string" ? JSON.parse(data.data) : data.data;

                // Validate and update UI
                if (!billData || !billData.booking_id) {
                    console.error("‚ùå Invalid bill data received:", billData);
                    return;
                }
                updateBillUI(billData);
            }
        } catch (error) {
            console.error("‚ùå WebSocket JSON Parsing Error:", error);
        }
    };

    socket.onclose = function (event) {
        console.warn("‚ö†Ô∏è WebSocket closed. Reconnecting in 3 seconds...", event);
        setTimeout(connectWebSocket, 3000);
    };

    socket.onerror = function (error) {
        console.error("üö® WebSocket Error:", error);
    };
}

// Function to update or add bill entry
function updateBillUI(billData) {
    const billsList = document.getElementById("bills-list");
    if (!billsList) {
        console.error("‚ùå Element with ID 'bills-list' not found!");
        return;
    }

    let existingBill = document.getElementById(`bill-${billData.booking_id}`);

    if (existingBill) {
        console.log("üîÑ Updating existing bill entry:", billData);
        existingBill.innerHTML = generateBillHTML(billData);
    } else {
        console.log("‚ûï Adding new bill entry:", billData);
        let newBill = document.createElement("div");
        newBill.classList.add("bill-card");
        newBill.id = `bill-${billData.booking_id}`;
        newBill.onclick = function () {
            openBill(billData.booking_id);
        };
        newBill.innerHTML = generateBillHTML(billData);
        billsList.prepend(newBill);
    }
}

// Function to generate bill card HTML
function generateBillHTML(billData) {
    return `
        <div class="bill-info">
            <div class="bill-row">
                <span class="customer"><strong>Booking ID:</strong> ${billData.booking_id}</span>
                <span class="vehicle"><strong>Car Type:</strong> ${billData.vehicle_type}</span>
                <span><strong>Payment Status:</strong> ${billData.status}</span>
            </div>
            <div class="bill-date">
                <span><strong>Date:</strong> ${new Date(billData.created_at).toLocaleString()}</span>
                <span class="total"><strong>Total:</strong> ‚Çπ${billData.total}</span>
            </div>
        </div>
    `;
}

// Open bill details
function openBill(bookingId) {
    window.location.href = `/garage/bills/${bookingId}/`;
}

// Initialize WebSocket connection
connectWebSocket();

{% comment %} adding the js  {% endcomment %}

const theSection = document.getElementById('bar')
const closeSection = document.getElementById('close')
const navberSection = document.getElementById('navber')

if(theSection){
  theSection.addEventListener( 'click',()=>{
      navberSection.classList.add('active')
  })
}
if(closeSection){
  closeSection.addEventListener('click',()=>{
      navberSection.classList.remove('active')
  })
}

</script>

{% endblock %}

{% extends "worker/index.html" %}
{% load static %}
{% block title %} Work Details{% endblock %}

{% block content %}

   <div class="wrapper">
       <div class="container">
           <div class="receipt-header">
               <meta name="csrf-token" content="{{ csrf_token }}"> 
               <i class="fas fa-arrow-left back-btn" onclick="window.location.href ='{% url 'home' %}' "></i>
               <h3 class="title">Work Details</h3>
               <span class="status">{{ work_data.status }}</span>
           </div>
           <div class="receipt-content" style="padding: 20px;">
               <input type="hidden" id="work_id" value="{{ work_data.id }}">
               <div class="item"><i class="fas fa-hashtag"></i> <strong>Work ID:</strong> <span>{{ work_data.id }}</span></div>
               <div class="item"><i class="fas fa-user"></i> <strong>Customer:</strong> <span>{{ work_data.customer_name }}</span></div>
               <div class="item"><i class="fas fa-map-marker-alt"></i> <strong>Location:</strong> <span>{{ work_data.location }}</span></div>
               {% if is_changable %}
               <div class="item"><i class="fas fa-sync-alt"></i> <strong>Change Status:</strong>
                   <select id="workerDropdown_{{ work_data.id }}" onchange="updateWorkStatus('{{ work_data.id }}')">
                       <option value="">Select a status</option>
                       {% for status in statuss %}
                           <option value="{{ status.id }}" {% if status.id == work_data.status %}selected{% endif %}>{{ status.name }}</option>
                       {% endfor %}
                   </select>
               </div>
               {% endif %}
               <div class="item">
                <i class="fas fa-tools"></i> <strong>Services:</strong>
                <div>
                    {% for service in work_data.services %}
                        <div> <img src="{{service.service_image}}" style="height:30px;"> {{ service.service_name }} - â‚¹{{ service.price }}</div>
                    {% endfor %}
                </div>
            </div>
           </div>
           <a href="{% url 'home' %}" class="btn">Back to Home</a>
       </div>
   </div>
</div>

   <script>
       function updateWorkStatus(workId) {
           const selectedStatus = document.getElementById(`workerDropdown_${workId}`).value;
           const workIdValue = document.getElementById('work_id').value;  
           
           if (selectedStatus) {
               const data = {
                   work_id: workIdValue,    
                   status: selectedStatus,  
               };

               const csrfToken = document.querySelector('[name="csrf-token"]').content;
               const url = "{% url 'worker_work_details' work_id=work_data.id %}";

               fetch(url, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                       'X-CSRFToken': csrfToken,  
                   },
                   body: JSON.stringify(data)
               })
               .then(response => response.json())
               .then(result => {
                    if (result.status === 'success' && result.updated_status === '3') {
                        window.location.href = '/';
                    }
                   if (result.status === 'success' && result.updated_status === '4') {
                       window.location.href = '/billing/';
                   }
               })
               .catch(error => {
                   console.error('Error updating status:', error);
               });
           }
       }
   </script>

   <style>
    .wrapper {
        justify-content: flex-start;
        align-items: center;
        flex-direction: column;
        display: flex;
        padding: 20px;
        margin: auto;
        height: 90vh;
    }
       .container {
           width:40%;
           background: white;
           border-radius: 10px;
           padding: 20px;
           box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
           margin: auto;
       }
       .receipt-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           font-size: 18px;
           font-weight: bold;
       }
       .title {
           font-size: 24px;
       }
       .status {
           color: green;
           font-weight: bold;
       }
       .item {
           display: flex;
           align-items: center;
           gap: 8px;
           font-size: 16px;
           margin: 8px 0;
       }
       .btn {
           display: block;
           text-align: center;
           margin-top: 15px;
           background: #007bff;
           color: white;
           padding: 10px;
           border-radius: 5px;
           text-decoration: none;
       }
       .btn:hover {
           background: #0056b3;
       }
   </style>
{% endblock %}

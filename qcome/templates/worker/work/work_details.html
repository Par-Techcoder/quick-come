{% extends "worker/index.html" %}
{% load static %}
{% block title %} Work Details{% endblock %}

{% block content %}

   <div class="wrapper">
       <div class="container">
           <div class="receipt-header">
               <meta name="csrf-token" content="{{ csrf_token }}"> 
               <i class="fas fa-arrow-left back-btn" onclick="window.location.href ='{% url 'home' %}' "></i>
               <h3 class="title">Work Details</h3>
               <span class="status">{{ work_data.status }}</span>
           </div>
           <div class="receipt-content" style="padding: 20px;">
               <input type="hidden" id="work_id" value="{{ work_data.id }}">
               <div class="item"><i class="fas fa-hashtag"></i> <strong>Work ID:</strong> <span>{{ work_data.id }}</span></div>
               <div class="item"><i class="fas fa-user"></i> <strong>Customer:</strong> <span>{{ work_data.customer_name }}</span></div>
               <div class="item"><i class="fas fa-map-marker-alt"></i> <strong>Location:</strong> <span>{{ work_data.location }}</span></div>
               {% if is_changable %}
               <div class="item"><i class="fas fa-sync-alt"></i> <strong>Change Status:</strong>
                   <select id="workerDropdown_{{ work_data.id }}" onchange="updateWorkStatus('{{ work_data.id }}')">
                       <option class="status">{{ work_data.status }}</option>
                       {% for status in statuss %}
                           <option value="{{ status.id }}" {% if status.id == work_data.status %}selected{% endif %}>{{ status.name }}</option>
                       {% endfor %}
                   </select>
               </div>
               {% endif %}
               <div class="item">
                <i class="fas fa-tools"></i> <strong>Services:</strong>
                <div>
                    {% for service in work_data.services %}
                        <div> <img src="{{service.service_image}}" style="height:30px;"> {{ service.service_name }} - ₹{{ service.price }}</div>
                    {% endfor %}
                </div>
            </div>
           </div>
           <a href="{% url 'home' %}" class="btn">Back to Home</a>
       </div>
   </div>
</div>

   <script>
        // Establish WebSocket connection
        const workSocket = new WebSocket("ws://localhost:8000/ws/bookings/");

        workSocket.onopen = function () {
            console.log("✅ WebSocket Connected for Work Status Updates");
        };
    
        workSocket.onerror = function (error) {
            console.error("❌ WebSocket Error:", error);
        };
    
        workSocket.onclose = function () {
            console.log("❌ WebSocket Disconnected");
        };
        
       function updateWorkStatus(workId) {
           const selectedStatus = document.getElementById(`workerDropdown_${workId}`).value;
           const workIdValue = document.getElementById('work_id').value;  
           
           if (selectedStatus) {
               const data = {
                   work_id: workIdValue,    
                   status: selectedStatus,  
               };

               const csrfToken = document.querySelector('[name="csrf-token"]').content;
               const url = "{% url 'worker_work_details' work_id=work_data.id %}";

               fetch(url, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                       'X-CSRFToken': csrfToken,  
                   },
                   body: JSON.stringify(data)
               })
               .then(response => response.json())
               .then(result => {
                    if (result.status === 'success' && (result.updated_status === '5' || result.updated_status === '6' || result.updated_status === '3')) {
                        window.location.href = '/';
                    }
                   if (result.status === 'success' && result.updated_status === '4') {
                       window.location.href = '/billing/';
                   }
               })
               .catch(error => {
                   console.error('Error updating status:', error);
               });
           }
       }
   </script>


{% endblock %}
